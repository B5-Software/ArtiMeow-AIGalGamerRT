<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IoT设备面板</title>
  <link rel="stylesheet" href="styles/iot-panel.css">
  <link rel="stylesheet" href="vendor/fontawesome/css/all.min.css">
</head>
<body>
  <div class="iot-panel">
    <!-- 头部 -->
    <div class="panel-header">
      <h1><i class="fa fa-heart-pulse"></i> IoT设备控制</h1>
      <button class="close-btn" onclick="window.close()">
        <i class="fa fa-times"></i>
      </button>
    </div>

    <!-- 标签页导航 -->
    <div class="tabs">
      <button class="tab-btn active" data-tab="connection">
        <i class="fa fa-plug"></i> 设备连接
      </button>
      <button class="tab-btn" data-tab="monitor">
        <i class="fa fa-chart-line"></i> 数据监控
      </button>
      <button class="tab-btn" data-tab="settings">
        <i class="fa fa-cog"></i> 游戏设置
      </button>
      <button class="tab-btn" data-tab="sri">
        <i class="fa fa-clipboard-check"></i> SRI测试
      </button>
    </div>

    <!-- 标签页内容 -->
    <div class="tab-content">
      <!-- 设备连接 -->
      <div class="tab-pane active" id="connection">
        <!-- 接入开关 -->
        <div class="setting-card">
          <div class="card-header">
            <h2><i class="fa fa-power-off"></i> IoT功能</h2>
          </div>
          <div class="card-body">
            <div class="switch-row">
              <div class="switch-info">
                <h3>启用IoT设备</h3>
                <p>开启后，游戏中将包含心率和SRI数据</p>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="iotEnabled">
                <span class="slider"></span>
              </label>
            </div>
          </div>
        </div>

        <!-- 连接状态 -->
        <div class="setting-card">
          <div class="card-header">
            <h2><i class="fa fa-signal"></i> 连接状态</h2>
          </div>
          <div class="card-body">
            <div class="status-display" id="connectionStatus">
              <div class="status-icon disconnected">
                <i class="fa fa-circle-xmark"></i>
              </div>
              <div class="status-text">
                <h3>未连接</h3>
                <p>请选择连接方式</p>
              </div>
            </div>
          </div>
        </div>

        <!-- WebSocket连接 -->
        <div class="setting-card">
          <div class="card-header">
            <h2><i class="fa fa-wifi"></i> WebSocket连接</h2>
          </div>
          <div class="card-body">
            <div class="input-group">
              <label>设备IP地址</label>
              <input type="text" id="deviceIP" placeholder="192.168.1.100">
              <small>设备连接到WiFi后的IP地址（可在设备配网页面查看）</small>
            </div>
            <button class="btn btn-primary" onclick="iotPanel.connectWebSocket()">
              <i class="fa fa-link"></i> 连接WebSocket
            </button>
          </div>
        </div>

        <!-- 串口连接 -->
        <div class="setting-card">
          <div class="card-header">
            <h2><i class="fa fa-usb"></i> USB串口连接</h2>
          </div>
          <div class="card-body">
            <div class="input-group">
              <label>串口端口</label>
              <select id="serialPort">
                <option value="">选择串口...</option>
              </select>
              <button class="btn btn-secondary btn-sm" onclick="iotPanel.refreshSerialPorts()">
                <i class="fa fa-rotate"></i> 刷新
              </button>
            </div>
            <div class="input-group">
              <label>波特率</label>
              <select id="baudRate">
                <option value="9600">9600</option>
                <option value="115200" selected>115200</option>
                <option value="230400">230400</option>
              </select>
            </div>
            <button class="btn btn-primary" onclick="iotPanel.connectSerial()">
              <i class="fa fa-link"></i> 连接串口
            </button>
          </div>
        </div>

        <!-- 断开连接 -->
        <div class="setting-card">
          <div class="card-body">
            <button class="btn btn-danger btn-block" onclick="iotPanel.disconnect()">
              <i class="fa fa-plug-circle-xmark"></i> 断开连接
            </button>
          </div>
        </div>
      </div>

      <!-- 数据监控 -->
      <div class="tab-pane" id="monitor">
        <!-- 实时心率 -->
        <div class="setting-card">
          <div class="card-header">
            <h2><i class="fa fa-heartbeat"></i> 实时心率</h2>
          </div>
          <div class="card-body">
            <div class="heart-rate-display">
              <div class="hr-value" id="currentHR">--</div>
              <div class="hr-label">BPM</div>
              <div class="hr-status" id="fingerStatus">
                <i class="fa fa-hand"></i> 等待检测...
              </div>
            </div>
          </div>
        </div>

        <!-- 心率趋势 -->
        <div class="setting-card">
          <div class="card-header">
            <h2><i class="fa fa-chart-area"></i> 心率趋势</h2>
          </div>
          <div class="card-body">
            <canvas id="heartRateChart" width="600" height="300"></canvas>
          </div>
        </div>

        <!-- 统计数据 -->
        <div class="setting-card">
          <div class="card-header">
            <h2><i class="fa fa-chart-pie"></i> 统计数据</h2>
          </div>
          <div class="card-body">
            <div class="stats-grid">
              <div class="stat-item">
                <div class="stat-label">平均心率</div>
                <div class="stat-value" id="avgHR">--</div>
              </div>
              <div class="stat-item">
                <div class="stat-label">最高心率</div>
                <div class="stat-value" id="maxHR">--</div>
              </div>
              <div class="stat-item">
                <div class="stat-label">最低心率</div>
                <div class="stat-value" id="minHR">--</div>
              </div>
              <div class="stat-item">
                <div class="stat-label">心率趋势</div>
                <div class="stat-value" id="trendHR">--</div>
              </div>
            </div>
          </div>
        </div>

        <!-- 情绪分析 -->
        <div class="setting-card">
          <div class="card-header">
            <h2><i class="fa fa-brain"></i> 情绪分析</h2>
          </div>
          <div class="card-body">
            <div class="emotion-grid">
              <div class="emotion-item">
                <div class="emotion-label">情绪状态</div>
                <div class="emotion-value" id="emotionState">--</div>
              </div>
              <div class="emotion-item">
                <div class="emotion-label">兴奋度</div>
                <div class="emotion-bar">
                  <div class="emotion-fill" id="excitementBar"></div>
                </div>
                <div class="emotion-percent" id="excitementPercent">0%</div>
              </div>
              <div class="emotion-item">
                <div class="emotion-label">紧张度</div>
                <div class="emotion-bar">
                  <div class="emotion-fill" id="tensionBar"></div>
                </div>
                <div class="emotion-percent" id="tensionPercent">0%</div>
              </div>
              <div class="emotion-item">
                <div class="emotion-label">参与度</div>
                <div class="emotion-bar">
                  <div class="emotion-fill" id="engagementBar"></div>
                </div>
                <div class="emotion-percent" id="engagementPercent">0%</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 游戏设置 -->
      <div class="tab-pane" id="settings">
        <!-- 游戏模式 -->
        <div class="setting-card">
          <div class="card-header">
            <h2><i class="fa fa-gamepad"></i> 游戏模式强度</h2>
          </div>
          <div class="card-body">
            <div class="slider-group">
              <label>模式强度 (类似LLM温度)</label>
              <div class="slider-display">
                <span>低</span>
                <input type="range" id="gameMode" min="1" max="10" value="5" step="1">
                <span>高</span>
              </div>
              <div class="slider-value">当前: <span id="gameModeValue">5</span> / 10</div>
              <small>强度越高，游戏内容对心率提升的需求度越大</small>
            </div>
          </div>
        </div>

        <!-- 心率目标 -->
        <div class="setting-card">
          <div class="card-header">
            <h2><i class="fa fa-shield-halved"></i> 安全设置</h2>
          </div>
          <div class="card-body">
            <div class="slider-group">
              <label>心率目标上限</label>
              <div class="slider-display">
                <span>80</span>
                <input type="range" id="heartRateTarget" min="80" max="180" value="120" step="5">
                <span>180</span>
              </div>
              <div class="slider-value">当前: <span id="targetValue">120</span> BPM</div>
              <small>⚠️ 为了您的健康安全，当心率接近此上限时，游戏将自动降低刺激强度</small>
            </div>
          </div>
        </div>

        <!-- 体感控制设置 -->
        <div class="setting-card">
          <div class="card-header">
            <h2><i class="fa fa-mobile-screen"></i> 体感控制</h2>
          </div>
          <div class="card-body">
            <div class="switch-row">
              <div class="switch-info">
                <h3>启用体感控制</h3>
                <p>使用设备摇动来控制游戏选项</p>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="gestureEnabled">
                <span class="slider"></span>
              </label>
            </div>

            <div class="slider-group" style="margin-top: 1rem;">
              <label>合加速度阈值</label>
              <div class="slider-display">
                <span>0.5g</span>
                <input type="range" id="gestureThreshold" min="0.5" max="10.0" value="2.0" step="0.1">
                <span>10.0g</span>
              </div>
              <div class="slider-value">当前: <span id="gestureThresholdValue">2.0</span> g</div>
              <small>摇动幅度超过此阈值才会触发 (建议 1.5-3.0g)</small>
            </div>

            <div class="slider-group" style="margin-top: 1rem;">
              <label>连续摇动时间间隔</label>
              <div class="slider-display">
                <span>200ms</span>
                <input type="range" id="gestureMaxInterval" min="200" max="2000" value="800" step="50">
                <span>2000ms</span>
              </div>
              <div class="slider-value">当前: <span id="gestureIntervalValue">800</span> ms</div>
              <small>在此时间内连续摇动两次视为确认动作</small>
            </div>

            <div class="slider-group" style="margin-top: 1rem;">
              <label>手势降噪时间间隔</label>
              <div class="slider-display">
                <span>0ms</span>
                <input type="range" id="gestureDebounceInterval" min="0" max="1000" value="200" step="50">
                <span>1000ms</span>
              </div>
              <div class="slider-value">当前: <span id="gestureDebounceValue">200</span> ms</div>
              <small>忽略过短时间间隔内的重复信号（降噪）</small>
            </div>

            <div class="info-box" style="margin-top: 1rem;">
              <i class="fa fa-info-circle"></i>
              <div>
                <strong>使用方法:</strong>
                <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                  <li><strong>单次摇动</strong> - 切换到下一个游戏选项 (循环)</li>
                  <li><strong>连续摇动两次</strong> - 确认当前选中的选项</li>
                </ul>
              </div>
            </div>
          </div>
        </div>

        <!-- 保存设置 -->
        <div class="setting-card">
          <div class="card-body">
            <button class="btn btn-primary btn-block" onclick="iotPanel.saveGameSettings()">
              <i class="fa fa-save"></i> 保存游戏设置
            </button>
          </div>
        </div>
      </div>

      <!-- SRI测试 -->
      <div class="tab-pane" id="sri">
        <div class="setting-card">
          <div class="card-header">
            <h2><i class="fa fa-clipboard-check"></i> 性压抑指数测试</h2>
          </div>
          <div class="card-body">
            <div class="sri-info">
              <p>SRI (Sexual Repression Index) 性压抑指数测试可以帮助评估您对性的态度和压抑程度。</p>
              <p>测试包含30道选择题，分为情感、身体和社会三个维度，大约需要5-10分钟完成。</p>
              <p>您的测试结果将被用于游戏内容的个性化调整，帮助创造更符合您需求的游戏体验。</p>
            </div>

            <div class="sri-result" id="sriResult">
              <h3>当前SRI指数</h3>
              <div class="sri-score-display">
                <div class="sri-score-number" id="sriScoreDisplay">--</div>
                <div class="sri-score-level" id="sriLevelDisplay">未测试</div>
              </div>
            </div>

            <button class="btn btn-primary btn-block" onclick="iotPanel.startSRITest()">
              <i class="fa fa-play"></i> 开始SRI测试
            </button>
          </div>
        </div>

        <!-- SRI说明 -->
        <div class="setting-card">
          <div class="card-header">
            <h2><i class="fa fa-info-circle"></i> 关于SRI测试</h2>
          </div>
          <div class="card-body">
            <div class="info-text">
              <h4>测试维度</h4>
              <ul>
                <li><strong>情感压抑:</strong> 对性欲望和情感表达的开放程度</li>
                <li><strong>身体压抑:</strong> 对自己身体和性反应的接纳程度</li>
                <li><strong>社会压抑:</strong> 受社会道德观念影响的程度</li>
              </ul>

              <h4>评分标准</h4>
              <ul>
                <li><strong>0-20:</strong> 极低压抑 - 性观念非常开放健康</li>
                <li><strong>20-40:</strong> 低度压抑 - 性观念比较开放</li>
                <li><strong>40-60:</strong> 中度压抑 - 对性持保守态度</li>
                <li><strong>60-80:</strong> 高度压抑 - 对性存在较强压抑</li>
                <li><strong>80-100:</strong> 极度压抑 - 对性持极度保守态度</li>
              </ul>

              <h4>隐私保护</h4>
              <p>测试结果仅保存在本地设备，不会上传到任何服务器。您的隐私得到完全保护。</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="js/utils.js"></script>
  <script src="js/iot-manager.js"></script>
  <script src="js/iot-panel.js"></script>
</body>
</html>
